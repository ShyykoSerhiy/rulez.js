/*! rulez.js 2015-05-20 */
var Rulez=function(a){"use strict";function b(a){var c,d=a.cloneNode(!1);if(a instanceof Element){var e=window.getComputedStyle(a);if(e)for(c=0;c<e.length;c++){var f=e[c];d.style.setProperty(f,e.getPropertyValue(f),"")}}for(c=0;c<a.childNodes.length;c++)d.appendChild(b(a.childNodes[c]));return d}function c(){G||z.divisions.forEach(function(a){a.pixelGap>G&&(G=a.pixelGap)}),w=F-F%G+G*A,v=-G*A}function d(a,b){z.divisions.forEach(function(c){e(a,b,c)});var c=0;z.texts.forEach(function(d){var e=f(a,b,d);C[c]?C[c]=C[c].concat(e):C.push(e),c++})}function e(a,b,c){for(var d=a;b>d;d+=c.pixelGap){var e=g(d,c);B.appendChild(e),c.renderer&&c.renderer(e)}}function f(a,b,c){for(var d=[],e=a;b>e;e+=c.pixelGap){var f=j(e,c);B.appendChild(f),c.renderer&&c.renderer(f),d.push(f)}return d}function g(a,b){switch(b.type){case"line":return h(a,b);case"rect":return i(a,b);default:return i(a,b)}}function h(a,b){var c,d,e,f,g=document.createElementNS(x,"line"),h=m();return l()?(c="y1",d="y2",e="x1",f="x2"):(c="x1",d="x2",e="y1",f="y2"),g.setAttribute("class",b.className),g.setAttribute(c,p(a)),g.setAttribute(d,p(a)),g.setAttribute(e,p(h?"0":n()-b.lineLength)),g.setAttribute(f,p(h?b.lineLength:n())),g.setAttribute("stroke-width",p(b.strokeWidth)),g}function i(a,b){var c,d,e,f,g=document.createElementNS(x,"rect"),h=m();return l()?(c="y",d="x",e="width",f="height"):(c="x",d="y",e="height",f="width"),g.setAttribute("class",b.className),g.setAttribute(c,p(a)),g.setAttribute(d,p(h?"0":n()-b.lineLength)),g.setAttribute(e,p(b.lineLength)),g.setAttribute(f,p(b.strokeWidth)),g}function j(a,b){var c,d,e=document.createElementNS(x,"text"),f=t(b);return e.setAttribute("class",b.className),l()?(c="y",d="x"):(c="x",d="y"),e.origPos=a,e.origPosAttribute=c,e.setAttribute(c,p(a)),e.setAttribute(d,p(f)),s(e,b),e.textContent=b.showUnits?p(a):a,b.centerText&&r(e,b),e}function k(){return document.createElementNS(x,"g")}function l(){return"vertical"===z.layout}function m(){return!("bottom"===z.alignment||"right"===z.alignment)}function n(){return l()?z.width:z.height}function o(a,b,c){if(!b)return a;for(var d in b)if(b.hasOwnProperty(d))switch(d){case"divisionDefaults":case"textDefaults":o(a[d],b[d]);break;default:c&&a[d]||(a[d]=b[d])}return a.divisions&&a.divisions.forEach(function(b){o(b,a.divisionDefaults,b),b.className||(b.className="line"===b.type?"rulez-line":"rulez-rect")}),a.texts&&a.texts.forEach(function(b){o(b,a.textDefaults,b)}),a}function p(a){return a+z.units}function q(){if(""===z.units||"px"===z.units)return 1;var a=document.createElement("div");a.style.position="absolute",a.style.top="-100000px",a.style.left="-100000px",a.style.zIndex=-1e5,a.style.width=a.style.height=p(1),document.body.appendChild(a);var b=window.getComputedStyle(a).width.replace("px","");return document.body.removeChild(a),b}function r(a,b){a.getBoundingClientRect&&(a.setAttribute(a.origPosAttribute,u(a,b)+""),s(a,b))}function s(a,b){var c,d=a.origPos,e=t(b);b.centerText&&a.getBoundingClientRect&&(d=u(a,b)),c=l()?"rotate("+b.rotation+" "+e*H+" "+d*H+")":"rotate("+b.rotation+" "+d*H+" "+e*H+")",a.setAttribute("transform",c)}function t(a){var b=m();return b?a.offset:n()-a.offset}function u(a,b){return a.origPos+a.getBoundingClientRect()[b.centerText.by]/2*("sum"===b.centerText.operation?1:-1)}var v,w,x="http://www.w3.org/2000/svg",y={width:null,height:null,element:null,layout:"horizontal",alignment:"top",units:"",divisionDefaults:{strokeWidth:1,type:"rect",className:"rulez-rect",renderer:null},textDefaults:{rotation:0,offset:25,className:"rulez-text",showUnits:!1,centerText:{by:"width",operation:"sub"},renderer:null},divisions:[{pixelGap:5,lineLength:5},{pixelGap:25,lineLength:10},{pixelGap:50,lineLength:15},{pixelGap:100,lineLength:20}],texts:[{pixelGap:100}]},z=o(JSON.parse(JSON.stringify(y)),a),A=2,B=k(),C=[],D=0,E=1;z.width=z.width?z.width:z.element.getBoundingClientRect().width,z.height=z.height?z.height:z.element.getBoundingClientRect().height,z.element.appendChild(B);var F=l()?z.height:z.width,G=0,H=q();this.render=function(){c(),d(v,w),this.scrollTo(0,!1)},this.scrollTo=function(a,b){D=a,b&&(D*=H),l()?B.setAttribute("transform","translate(0,"+-D%(G*H)+")"):B.setAttribute("transform","translate("+-D%(G*H)+",0)");for(var c=D/H,d=0;d<z.texts.length;d++)for(var e=z.texts[d],f=C[d],g=G/e.pixelGap,h=c%G,i=c-h,j=0;j<f.length;j++){var k=f[j],m=Math.floor((i+(j-A*g)*e.pixelGap)*E);e.showUnits&&(m=p(m)),k.textContent=m,e.centerText&&r(k,e)}},this.setScale=function(a){E=a,this.scrollTo(D,!1)},this.resize=function(){var a=F,b=l()?z.element.clientHeight:z.element.clientWidth;if(a!==b)if(a>b);else{F=b;var e=w;c(),d(e,w),this.scrollTo(D,!1)}},this.saveAsImage=function(a){var c=b(z.element);c.setAttribute("width",z.width),c.setAttribute("height",z.height);var d=document.createElement("canvas");d.setAttribute("width",z.width),d.setAttribute("height",z.height);var e=d.getContext("2d"),f=window.URL||window.webkitURL,g=new Image;g.style.position="absolute",g.style.top="-100000px",g.style.left="-100000px",g.style.zIndex=-1e5,g.setAttribute("width",z.width),g.setAttribute("height",z.height);var h=new Blob([c.outerHTML],{type:"image/svg+xml;charset=utf-8"}),i=f.createObjectURL(h);g.onload=function(){setTimeout(function(){e.drawImage(g,0,0),f.revokeObjectURL(i),document.body.removeChild(g),a(d.toDataURL())},1e3)},document.body.appendChild(g),g.src=i},this.getUnitConversionRate=function(){return q()}};